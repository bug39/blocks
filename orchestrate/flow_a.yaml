# Unblocker Flow A - PR Reviewer Request
# This flow is orchestrated by watsonx Orchestrate
#
# Key points:
# - run_id is generated by Orchestrate and passed to all tools
# - Approval decision is made by Orchestrate based on approval_required flag
# - Backend is stateless; Orchestrate owns the workflow state

name: unblocker_flow_a
description: Analyze stalled PR and request reviewers with approval gating
version: "1.0"

trigger:
  type: slack_command
  pattern: "/unblock why <pr_url>"

steps:
  - id: analyze
    name: Fetch Evidence & Analyze
    tool: unblocker.analyze
    inputs:
      pr_url: "{{ trigger.pr_url }}"
      run_id: "{{ orchestrate.run_id }}"
      mode: "why"
    outputs:
      - matched
      - confidence
      - approval_required
      - auto_execute
      - preview_blocks
      - plan

  - id: preview
    name: Post Slack Preview
    action: slack.post_message
    inputs:
      channel: "{{ trigger.channel }}"
      blocks: "{{ steps.analyze.preview_blocks }}"

  - id: approval_gate
    name: Approval Decision
    type: conditional
    condition: "{{ steps.analyze.approval_required }}"
    branches:
      true:
        - id: wait_approval
          name: Wait for User Approval
          action: slack.await_interaction
          timeout: 300  # 5 minutes
          buttons:
            - id: approve
              label: "Approve"
              style: primary
            - id: cancel
              label: "Cancel"
              style: danger
      false:
        - id: auto_countdown
          name: Auto-Execute Countdown
          action: slack.countdown
          duration: 20  # seconds
          cancel_button: true

  - id: execute
    name: Request Reviewers
    tool: unblocker.act
    condition: "{{ approval_gate.result != 'cancelled' }}"
    inputs:
      run_id: "{{ orchestrate.run_id }}"
      approved: true
    outputs:
      - status
      - reviewers
      - verified
      - outcome_text

  - id: outcome
    name: Post Outcome
    action: slack.post_message
    inputs:
      channel: "{{ trigger.channel }}"
      text: "{{ steps.execute.outcome_text }}"

audit:
  run_id: "{{ orchestrate.run_id }}"
  correlation:
    - slack_thread_ts
    - github_pr_url
